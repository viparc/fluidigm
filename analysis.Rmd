---
title: "Kiet's study analyzed by Avijit"
output:
  html_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r}
library(readxl)
library(purrr)
library(dplyr)
library(stringr)
library(tidyr)
library(magrittr)
```

## Loading the data

### Antimicrobial use

Date and type of antimicrobial use per farm:

```{r}
amu <- read_excel("AMU_KietStudy_Marc.xlsx")
```

### Antimicrobial classes

Antimicrobial class of each antimicrobial:

```{r}
classes <- read_excel("FarmvsClass.xlsx")
```

### Resistance genes concentrations

Resistance genes concentrations in chicken:

```{r}
farms <- paste0("K", c(formatC(6:9, 1, flag = "0"), 11:26))

genes <- farms %>%
  map(read_excel, path = "KietAnalysisData.xlsx") %>% 
  map(filter, Group.1 %in% c("Chicken-Control", "Chicken-Treatment")) %>% 
  map(select, -Group.1) %>% 
  setNames(farms)
```

Let's check that the names of the columns are the same for all the farms:

```{r}
tmp <- genes %>%
  map_df(names) %>% 
  apply(1, unique)

tmp[map_int(tmp, length) > 1]
```

There is a problem with with the `FarmID` variable that is called `K09` is one
farm. Let's fix this. The names of the variables seem OK in the first farm:

```{r}
(correct_names <- names(genes[[1]]))
```

Let's use them as variables names for all the farms:

```{r}
genes %<>% map(setNames, correct_names)
```

Note also that not all farms have a "Before" measurement in the control group:

```{r}
tmp <- genes %>%
  map(~ .x %>% filter(SamplingDay == "Before") %>% select(Group)) %>% 
  .[map_int(., nrow) < 2] %>% 
  unlist()

tmp
```

For the farms where the "Before" measurement is missing in the control group,
let's just use the "Before" measurement of the treatment group. First, we need
this function:

```{r}
control_before <- function(x) {
  y <- filter(x, SamplingDay == "Before")
  y$Group <- "Control"
  y$Sample_Name <- NA
  rbind(x, y)
}
```

Now we can use this function to make the fix:

```{r}
farms_to_fix <- tmp %>% 
  names() %>% 
  str_remove(".Group")

fixed_farms <- genes %>% 
  extract(farms_to_fix) %>% 
  map(control_before)

genes[farms_to_fix] <- fixed_farms
```

Names of resistance genes:

```{r}
resistance_genes <- setdiff(names(genes[[1]]),
                          c("FarmID", "Group", "Sample_Name", "SamplingDay", "TotalLog2Value"))
```

## Computing sums of resistance genes

The antimicrobial classes to which each resistance gene corresponds:

```{r}
(classes_names <- unique(classes$Antimicrobial_Class))
```

```{r}
cln <- classes_names[1]

ttt <- classes %>%
  filter(Antimicrobial_Class == cln) %>% 
  pull(EvaGreen_Name)

rowSums(genes[[1]][ttt])
```

```{r}
farm <- genes[[1]]

am_class <- classes_names[1]

sum_by_class <- function(am_class, farm) {
  classes %>%
    filter(Antimicrobial_Class == am_class) %>% 
    pull(EvaGreen_Name) %>% 
    extract(farm, .) %>% 
    rowSums()
}

add_sums_by_class <- function(farm) {
  farm %>%
    map_dfc(classes_names, sum_by_class, .) %>% 
    setNames(classes_names) %>% 
    bind_cols(genes[[1]], .)
}

map(genes[1:2], add_sums_by_class)

genes[[3]]
```

```{r}
sort(unique(amu$AAI))
```

```{r}
resistance_genes
```

## Plotting the data per farm and gene

The time points:

```{r}
genes %>%
  map(pull, SamplingDay) %>% 
  unlist() %>% 
  unique()
```

Generating new time points:

```{r}
genes %<>% map(mutate,
               SamplingDay2 = as.integer(recode(SamplingDay,
                                                Before = "-7",
                                                After  = "0",
                                                End    = "120"))) %>% 
  map(arrange, Group, SamplingDay2) # making sure that data are arranged chronologically
```

A customized `lines()` function:

```{r}
lines2 <- function(...) lines(..., type = "o", lwd = 2)
```

A function that plots a given gene concentration as a function of time for
control and treatment:

```{r}
plot_gene_concentration <- function(farm, antimicrobial, text) {
  farm_dataset <- genes[[farm]]
  
  plot(farm_dataset$SamplingDay2, farm_dataset[[antimicrobial]], type = "n",
       xlim = c(-8, 120), xlab = "time (days)", ylab = "gene concentration")

  controls <- filter(farm_dataset, Group == "Control")
  treatments <- filter(farm_dataset, Group == "Treatment")

  lines2(controls$SamplingDay2, controls[[antimicrobial]], col = "blue")
  lines2(treatments$SamplingDay2, treatments[[antimicrobial]], col = "red")
  
  mtext(text)
}
```

Plotting aac3-liacde for control and treatment in farm K06

```{r}
plot_gene_concentration(farms[1], resistance_genes[1], resistance_genes[1])
```

Number of columns we want:

```{r}
ncols <- 3
```

Plotting all the genes for the first farm:

```{r fig.height = ceiling(length(resistance_genes) / ncols) * (1 + 2 / 3)}
opar <- par(mfrow = c(ceiling(length(resistance_genes) / ncols), ncols),
            plt   = c(.13, .92, .22, .9))

walk(resistance_genes, ~ plot_gene_concentration(farms[1], .x, .x))

par(opar)
```

Plotting all the farms for the first gene:

```{r fig.height = ceiling(length(farms) / ncols) * (1 + 2 / 3)}
opar <- par(mfrow = c(ceiling(length(farms) / ncols), ncols),
            plt   = c(.13, .92, .22, .9))

walk(farms, ~ plot_gene_concentration(.x, resistance_genes[1], .x))

par(opar)
```

## Gathering farms data

### Standardizing the data

Let's now try to standardize the gene concentrations by the gene concentration
before treatment. This function standardizes one experiment:

```{r}
standardize_by_before_ <- function(x) {
  rbind(rep(1, length(resistance_genes)),
        sweep(as.matrix(x[x$SamplingDay != "Before", resistance_genes]), 2,
                 unlist(x[x$SamplingDay == "Before", resistance_genes]), `/`))
}
```

This function standardizes the control of and the treatment experiments of a
farm:

```{r}
standardize_by_before <- function(x) {
  x[, resistance_genes] <- rbind(standardize_by_before_(filter(x, Group == "Control")),
                                 standardize_by_before_(filter(x, Group == "Treatment")))
  
  x
}
```

Let's standardize the gene concentrations for all the farms:

```{r}
genes_standardized <- map(genes, standardize_by_before)
```

Let's now plot all the farms on a single plot for a given antimicrobial. Let's
first define the following function that draw the layout the plot:

```{r}
plot_frame <- function(...) {
  plot(..., type = "n", xlab = "time (days)", ylab = "standardized genes concentrations")
}
```

### Experiments time series

Now, we can start exploring various option of plotting the data, starting with
this function:

```{r}
plot_gene_all_farms <- function(antimicrobial) {
  tmp <- genes_standardized %>% 
    map(extract, c("Group", "SamplingDay2", antimicrobial))

  tmp2 <- bind_rows(tmp)
  plot_frame(tmp2[[2]], tmp2[[3]])

  tmp %>%
    map(filter, Group == "Control") %>% 
    walk(~ lines2(.x[[2]], .x[[3]], col = "blue"))

  tmp %>%
    map(filter, Group == "Treatment") %>% 
    walk(~ lines2(.x[[2]], .x[[3]], col = "red"))
  
  mtext(antimicrobial)
  legend("topright", legend = c("treatment", "control"), col = c("red", "blue"),
         lty = 1, lwd = 2, bty = "n")
}
```

Let's try it on one antimicrobial:

```{r}
plot_gene_all_farms(resistance_genes[1])
```

### Boxplots

Let's try an alternative visualization, using this following function for
box-plots:

```{r}
boxplot2 <- function(x, eps, col, ...) {
  boxplot(x[[3]] ~ x[[2]], at =  unique(x[[2]]) + eps, add = TRUE, axes = FALSE,
          boxwex = 2.5, col = adjustcolor(col, .5), outline = FALSE, ...)
}
```

Here is the alternative visualization:

```{r}
plot_gene_all_farms_boxplot <- function(antimicrobial) {
  eps <- 1.5
  
  tmp <- genes_standardized %>% 
    map(filter, SamplingDay != "Before") %>% 
    map(extract, c("Group", "SamplingDay2", antimicrobial))

  tmp2 <- bind_rows(tmp)
  plot_frame(tmp2[[2]], tmp2[[3]])

  control <- map(tmp, filter, Group == "Control")
  walk(control, ~ points(jitter(.x[[2]] - 2), .x[[3]], col = "blue"))
  control %>%
    bind_rows() %>% 
    boxplot2(-eps, col = "blue")
  
  treatment <- map(tmp, filter, Group == "Treatment")
  walk(treatment, ~ points(jitter(.x[[2]] + 2), .x[[3]], col = "red"))
  treatment %>%
    bind_rows() %>% 
    boxplot2(eps, col = "red")
  
  mtext(antimicrobial)
  legend("topright", legend = c("treatment", "control"), fill = c("red", "blue"), bty = "n")
}
```

Let's try it:

```{r}
plot_gene_all_farms_boxplot(resistance_genes[1])
```

Mmmm... For some reason, interquartiles ranges look a bit weird on some of these
boxplots. Not sure how this is calculated but I don't really like it.

### Violin plots

Let's try a violin plot instead, by using this function:

```{r}
vioplot2 <- function(x, eps, color, ...) {
  vioplot::vioplot(x[[3]] ~ x[[2]], at =  unique(x[[2]]) + eps, add = TRUE,
                   axes = FALSE, fill = color, lineCol = color, border = color,
                   wex = 4, col = adjustcolor(color, .5), ...)
}
```

And the new plotting function:

```{r}
plot_gene_all_farms_violin <- function(antimicrobial) {
  eps <- 1.5
  
  tmp <- genes_standardized %>% 
    map(filter, SamplingDay != "Before") %>% 
    map(extract, c("Group", "SamplingDay2", antimicrobial))

  tmp2 <- bind_rows(tmp)
  plot_frame(tmp2[[2]], tmp2[[3]])

  control <- map(tmp, filter, Group == "Control")
  walk(control, ~ points(jitter(.x[[2]] - 2), .x[[3]], col = "blue"))
  control %>%
    bind_rows() %>% 
    vioplot2(-eps, "blue")
  
  treatment <- map(tmp, filter, Group == "Treatment")
  walk(treatment, ~ points(jitter(.x[[2]] + 2), .x[[3]], col = "red"))
  treatment %>%
    bind_rows() %>% 
    vioplot2(eps, "red")
  
  mtext(antimicrobial)
  legend("topright", legend = c("treatment", "control"), fill = c("red", "blue"), bty = "n")
}
```

Let's try it too:

```{r}
plot_gene_all_farms_violin(resistance_genes[1])
```

Not sure I like it either...

### Paired treatment and control

Let's plot paired treatment and control for each farm instead. For that, we need
the following function:

```{r}
plot_gene_all_farms_pairwise <- function(antimicrobial) {
  col_val <- adjustcolor(c("blue", "red"), .5)

  genes %>% 
    map(extract, c("SamplingDay2", "Group", antimicrobial)) %>% 
    map(pivot_wider, names_from = Group, values_from = 3) %>% 
    bind_rows() %>% 
    mutate(SamplingDay3 = jitter(SamplingDay2),
           color = (Treatment > Control) + 1) %>% 
    with({
      plot_frame(rep(SamplingDay3, 2), c(Control, Treatment))
      points(SamplingDay3, Control, col = "blue")
      points(SamplingDay3, Treatment, col = "red")
      arrows(SamplingDay3, Control, SamplingDay3, Treatment, 0, col = col_val[color])
    })
  
  mtext(antimicrobial)
}
```

Let's try it:

```{r}
plot_gene_all_farms_pairwise(resistance_genes[1])
```

## Differences between treatment and control

### Experiment time series

Let's plot the difference between treatment and control for each farm. For that,
we need the following function:

```{r}
plot_differences <- function(antimicrobial) {
  tmp <- genes %>% 
    map(extract, c("SamplingDay2", "Group", antimicrobial)) %>% 
    map(pivot_wider, names_from = Group, values_from = 3) %>% 
    map(mutate, difference = Treatment - Control)

  tmp %>% 
    bind_rows() %$% 
    plot_frame(SamplingDay2, difference)
  
  walk(tmp, ~ with(.x, lines2(SamplingDay2, difference, col = "green")))

  abline(h = 0)
  mtext(antimicrobial)
}
```

Let's try it:

```{r}
plot_differences(resistance_genes[1])
```

### Boxplots

Let's consider this function with boxplots:

```{r}
plot_differences_boxplot <- function(antimicrobial) {
  
  tmp <- genes %>% 
    map(extract, c("SamplingDay2", "Group", antimicrobial)) %>% 
    map(pivot_wider, names_from = Group, values_from = 3) %>% 
    map(mutate, difference = Treatment - Control) %>% 
    bind_rows()

  with(tmp, plot(jitter(SamplingDay2), difference, col = "green",
                 xlab = "time (days)",
                 ylab = "difference in standardized genes concentrations"))
  
  tmp %>% 
    select(2, 1, 3) %>% 
    boxplot2(0, col = "green")

  abline(h = 0)
  mtext(antimicrobial)
}
```

Let's try it:

```{r}
plot_differences_boxplot(resistance_genes[1])
```

The boxplot still looks weird.

### Violin plots

Let's look at the violin alternative:

```{r}
plot_differences_violin <- function(antimicrobial) {
  
  tmp <- genes %>% 
    map(extract, c("SamplingDay2", "Group", antimicrobial)) %>% 
    map(pivot_wider, names_from = Group, values_from = 3) %>% 
    map(mutate, difference = Treatment - Control) %>% 
    bind_rows()

  with(tmp, plot(jitter(SamplingDay2), difference, col = "green",
                 xlab = "time (days)",
                 ylab = "difference in standardized genes concentrations"))
  
  tmp %>% 
    select(2, 1, 3) %>% 
    vioplot2(0, col = "green")

  abline(h = 0)
  mtext(antimicrobial)
}
```

Let's try it:

```{r}
plot_differences_violin(resistance_genes[1])
```

Same comment.

### Quantiles

Let's consider another option.

```{r}
plot_differences_quantiles <- function(antimicrobial) {
  tmp <- genes %>% 
    map(extract, c("SamplingDay2", "Group", antimicrobial)) %>% 
    map(pivot_wider, names_from = Group, values_from = 3) %>% 
    map(mutate, difference = Treatment - Control) %>% 
    bind_rows()

  with(tmp, plot(jitter(SamplingDay2), difference, col = "darkgrey",
                 xlab = "time (days)",
                 ylab = "difference in standardized genes concentrations"))

  x_val <- sort(unique(tmp$SamplingDay2))
  
  tmp %>%
    select(SamplingDay2, difference) %>% 
    group_by(SamplingDay2) %>% 
    group_split() %>% 
    map(~ quantile(.x$difference, c(.25, .5, .75), na.rm = TRUE)) %>% 
    bind_rows() %>% 
    mutate(x_val = x_val) %>% 
    with({
      points(x_val, `50%`, lwd = 2)
      arrows(x_val, `25%`, x_val, `75%`, .1, 90, 3, lwd = 2, col = "black")
      lines(x_val, `25%`, lty = 3)
      lines(x_val, `50%`, lty = 2)
      lines(x_val, `75%`, lty = 3)
    })
  
  abline(h = 0)
  mtext(antimicrobial)
}
```

Let's try it:

```{r}
plot_differences_quantiles(resistance_genes[1])
```

